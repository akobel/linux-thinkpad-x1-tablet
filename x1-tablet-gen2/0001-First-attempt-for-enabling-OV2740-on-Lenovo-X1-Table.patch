From 93c5a157baa8641aa4aa368eae96e98e6f1ae193 Mon Sep 17 00:00:00 2001
From: Alexander Kobel <a-kobel@a-kobel.de>
Date: Mon, 7 Mar 2022 16:01:50 +0100
Subject: [PATCH] First attempt for enabling OV2740 on Lenovo X1 Tablet Gen2
 (unsuccessful)

---
 drivers/media/pci/intel/ipu3/cio2-bridge.c    |   2 +
 .../x86/intel/int3472/tps68470_board_data.c   | 141 ++++++++++++++++++
 2 files changed, 143 insertions(+)

diff --git a/drivers/media/pci/intel/ipu3/cio2-bridge.c b/drivers/media/pci/intel/ipu3/cio2-bridge.c
index 7ccb7b6eaa82..1b6f2e06f7c8 100644
--- a/drivers/media/pci/intel/ipu3/cio2-bridge.c
+++ b/drivers/media/pci/intel/ipu3/cio2-bridge.c
@@ -23,6 +23,8 @@
 static const struct cio2_sensor_config cio2_supported_sensors[] = {
 	/* Omnivision OV5693 */
 	CIO2_SENSOR_CONFIG("INT33BE", 1, 419200000),
+	/* Omnivision OV2740 */
+	CIO2_SENSOR_CONFIG("INT3474", 1, 360000000),
 	/* Omnivision OV8865 */
 	CIO2_SENSOR_CONFIG("INT347A", 1, 360000000),
 	/* Omnivision OV2680 */
diff --git a/drivers/platform/x86/intel/int3472/tps68470_board_data.c b/drivers/platform/x86/intel/int3472/tps68470_board_data.c
index 49a3591c6d85..6bf828ea2bea 100644
--- a/drivers/platform/x86/intel/int3472/tps68470_board_data.c
+++ b/drivers/platform/x86/intel/int3472/tps68470_board_data.c
@@ -15,6 +15,32 @@
 #include <linux/regulator/machine.h>
 #include "tps68470.h"
 
+static struct regulator_consumer_supply int3474_core_consumer_supplies[] = {
+	REGULATOR_SUPPLY("dvdd", "i2c-INT3474:01"),
+};
+
+static struct regulator_consumer_supply int3474_ana_consumer_supplies[] = {
+	REGULATOR_SUPPLY("avdd", "i2c-INT3474:01"),
+};
+
+static struct regulator_consumer_supply int3474_vcm_consumer_supplies[] = {
+	REGULATOR_SUPPLY("vdd", "i2c-INT3474:01-VCM"),
+};
+
+static struct regulator_consumer_supply int3474_vsio_consumer_supplies[] = {
+	REGULATOR_SUPPLY("dovdd", "i2c-INT3474:01"),
+	REGULATOR_SUPPLY("vsio", "i2c-INT3474:01-VCM"),
+	REGULATOR_SUPPLY("vddd", "i2c-INT347E:00"),
+};
+
+static struct regulator_consumer_supply int3474_aux1_consumer_supplies[] = {
+	REGULATOR_SUPPLY("vdda", "i2c-INT347E:00"),
+};
+
+static struct regulator_consumer_supply int3474_aux2_consumer_supplies[] = {
+	REGULATOR_SUPPLY("vdddo", "i2c-INT347E:00"),
+};
+
 static struct regulator_consumer_supply int347a_core_consumer_supplies[] = {
 	REGULATOR_SUPPLY("dvdd", "i2c-INT347A:00"),
 };
@@ -146,6 +172,114 @@ static struct gpiod_lookup_table surface_go_int347e_gpios = {
 	}
 };
 
+static const struct regulator_init_data lenovo_x1t_tps68470_core_reg_init_data = {
+	.constraints = {
+		.min_uV = 1200000, /* should be 1198000? */
+		.max_uV = 1200000, /* should be 1198000? */
+		.apply_uV = true,
+		.valid_ops_mask = REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies = ARRAY_SIZE(int3474_core_consumer_supplies),
+	.consumer_supplies = int3474_core_consumer_supplies,
+};
+
+static const struct regulator_init_data lenovo_x1t_tps68470_ana_reg_init_data = {
+	.constraints = {
+		.min_uV = 2815200,
+		.max_uV = 2815200,
+		.apply_uV = true,
+		.valid_ops_mask = REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies = ARRAY_SIZE(int3474_ana_consumer_supplies),
+	.consumer_supplies = int3474_ana_consumer_supplies,
+};
+
+static const struct regulator_init_data lenovo_x1t_tps68470_vcm_reg_init_data = {
+	.constraints = {
+		.min_uV = 2815200,
+		.max_uV = 2815200,
+		.apply_uV = true,
+		.valid_ops_mask = REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies = ARRAY_SIZE(int3474_vcm_consumer_supplies),
+	.consumer_supplies = int3474_vcm_consumer_supplies,
+};
+
+/* Ensure the always-on VIO regulator has the same voltage as VSIO */
+static const struct regulator_init_data lenovo_x1t_tps68470_vio_reg_init_data = {
+	.constraints = {
+		.min_uV = 1800600,
+		.max_uV = 1800600,
+		.apply_uV = true,
+		.always_on = true,
+	},
+};
+
+static const struct regulator_init_data lenovo_x1t_tps68470_vsio_reg_init_data = {
+	.constraints = {
+		.min_uV = 1800600,
+		.max_uV = 1800600,
+		.apply_uV = true,
+		.valid_ops_mask = REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies = ARRAY_SIZE(int3474_vsio_consumer_supplies),
+	.consumer_supplies = int3474_vsio_consumer_supplies,
+};
+
+static const struct regulator_init_data lenovo_x1t_tps68470_aux1_reg_init_data = {
+	.constraints = {
+		.min_uV = 2815200,
+		.max_uV = 2815200,
+		.apply_uV = 1,
+		.valid_ops_mask = REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies = ARRAY_SIZE(int3474_aux1_consumer_supplies),
+	.consumer_supplies = int3474_aux1_consumer_supplies,
+};
+
+static const struct regulator_init_data lenovo_x1t_tps68470_aux2_reg_init_data = {
+	.constraints = {
+		.min_uV = 1800600,
+		.max_uV = 1800600,
+		.apply_uV = 1,
+		.valid_ops_mask = REGULATOR_CHANGE_STATUS,
+	},
+	.num_consumer_supplies = ARRAY_SIZE(int3474_aux2_consumer_supplies),
+	.consumer_supplies = int3474_aux2_consumer_supplies,
+};
+
+static const struct tps68470_regulator_platform_data lenovo_x1t_tps68470_pdata = {
+	.reg_init_data = {
+		[TPS68470_CORE] = &lenovo_x1t_tps68470_core_reg_init_data,
+		[TPS68470_ANA]  = &lenovo_x1t_tps68470_ana_reg_init_data,
+		[TPS68470_VCM]  = &lenovo_x1t_tps68470_vcm_reg_init_data,
+		[TPS68470_VIO]  = &lenovo_x1t_tps68470_vio_reg_init_data,
+		[TPS68470_VSIO] = &lenovo_x1t_tps68470_vsio_reg_init_data,
+		[TPS68470_AUX1] = &lenovo_x1t_tps68470_aux1_reg_init_data,
+		[TPS68470_AUX2] = &lenovo_x1t_tps68470_aux2_reg_init_data,
+	},
+};
+
+static struct gpiod_lookup_table lenovo_x1t_int3474_gpios = {
+	.dev_id = "i2c-INT3474:00",
+	.table = {
+		GPIO_LOOKUP("tps68470-gpio", 9, "reset", GPIO_ACTIVE_LOW),
+		GPIO_LOOKUP("tps68470-gpio", 7, "powerdown", GPIO_ACTIVE_LOW),
+		{ }
+	}
+};
+
+static const struct int3472_tps68470_board_data lenovo_x1t_tps68470_board_data = {
+	.dev_name = "i2c-INT3472:05",
+	.tps68470_regulator_pdata = &lenovo_x1t_tps68470_pdata,
+	.n_gpiod_lookups = 3,
+	.tps68470_gpio_lookup_tables = {
+		&lenovo_x1t_int3474_gpios,
+		&surface_go_int347a_gpios,
+		&surface_go_int347e_gpios,
+	}
+};
+
 static const struct int3472_tps68470_board_data surface_go_tps68470_board_data = {
 	.dev_name = "i2c-INT3472:05",
 	.tps68470_regulator_pdata = &surface_go_tps68470_pdata,
@@ -174,6 +308,13 @@ static const struct dmi_system_id int3472_tps68470_board_data_table[] = {
 		},
 		.driver_data = (void *)&surface_go_tps68470_board_data,
 	},
+	{
+		.matches = {
+			DMI_EXACT_MATCH(DMI_SYS_VENDOR, "LENOVO"),
+			DMI_EXACT_MATCH(DMI_PRODUCT_NAME, "20JCS00C00"),
+		},
+		.driver_data = (void *)&lenovo_x1t_tps68470_board_data,
+	},
 	{
 		.matches = {
 			DMI_EXACT_MATCH(DMI_SYS_VENDOR, "Microsoft Corporation"),
-- 
2.35.1

